<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>RX5808-Div Firmware Configurator</title>
    <meta name="description" content="Firmware management for RX5808 Diversity FPV drone video receivers" />
    <meta name="viewport" content="width=device-width" />
    <meta name="color-scheme" content="dark light" />
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        padding: 0;
        margin: 0;
        line-height: 1.7;
        background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
        transition: background-color 0.3s ease;
      }
      
      .header {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        color: white;
        padding: 60px 20px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: background 0.3s ease;
      }
      
      .header h1 {
        font-size: 36px;
        font-weight: 600;
        margin-bottom: 12px;
        letter-spacing: -0.5px;
      }
      
      .header p {
        font-size: 18px;
        opacity: 0.95;
        max-width: 700px;
        margin: 0 auto;
        font-weight: 400;
      }
      
      .container {
        max-width: 900px;
        margin: -40px auto 60px;
        padding: 0 20px;
      }
      
      .card {
        background: white;
        border-radius: 8px;
        padding: 32px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
      }
      
      .card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1), 0 8px 24px rgba(0,0,0,0.08);
      }
      
      h2 {
        font-size: 24px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: color 0.3s ease;
      }
      
      h3 {
        font-size: 18px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
        transition: color 0.3s ease;
      }
      
      .version-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 16px;
      }
      
      .version-header h2 {
        margin: 0;
      }
      
      .version-selector {
        padding: 10px 16px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        background: #ffffff;
        color: #111827;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
        font-family: inherit;
        min-width: 180px;
        transition: all 0.2s;
      }
      
      .version-selector:hover {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .version-selector:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      }
      
      .version-selector option {
        padding: 10px;
        background: #ffffff;
        color: #111827;
        font-size: 15px;
      }
      
      .version-info {
        display: flex;
        gap: 24px;
        margin-bottom: 24px;
        padding: 16px;
        background: #f9fafb;
        border-radius: 6px;
        font-size: 14px;
        flex-wrap: wrap;
      }
      
      .version-info span {
        color: #6b7280;
      }
      
      .version-info strong {
        color: #374151;
        font-weight: 600;
      }
      
      esp-web-install-button {
        display: block;
        margin: 20px auto;
      }
      
      .info-box {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
        padding: 20px;
        border-radius: 6px;
      }
      
      .info-box h3 {
        color: #1e40af;
        font-size: 16px;
        margin-bottom: 12px;
      }
      
      .info-box ul {
        list-style: none;
        padding: 0;
      }
      
      .info-box li {
        color: #1e40af;
        margin: 8px 0;
        padding-left: 24px;
        position: relative;
      }
      
      .info-box li:before {
        content: "•";
        position: absolute;
        left: 8px;
        font-weight: bold;
      }
      
      .footer {
        text-align: center;
        padding: 40px 20px;
        font-size: 14px;
        color: #6b7280;
        border-top: 1px solid #e5e7eb;
        background: #ffffff;
      }
      
      .footer a {
        color: #3b82f6;
        text-decoration: none;
        font-weight: 500;
      }
      
      .footer a:hover {
        color: #2563eb;
        text-decoration: underline;
      }
      
      .release-notes {
        color: #374151;
        line-height: 1.7;
      }
      
      .release-notes h3, .release-notes h4 {
        color: #111827;
        margin-top: 16px;
        margin-bottom: 8px;
      }
      
      .release-notes ul {
        padding-left: 24px;
        margin: 12px 0;
      }
      
      .release-notes li {
        margin: 6px 0;
        color: #4b5563;
      }
      
      .release-notes p {
        margin: 12px 0;
        color: #4b5563;
      }
      
      .features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
        margin: 24px 0;
      }
      
      .feature {
        padding: 20px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        transition: all 0.2s;
      }
      
      .feature:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border-color: #d1d5db;
      }
      
      .feature h3 {
        font-size: 15px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 8px;
      }
      
      .feature p {
        margin: 0;
        font-size: 14px;
        color: #6b7280;
        line-height: 1.6;
      }
      
      .install-button {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border: none;
        padding: 16px 32px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
      }
      
      .install-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.35);
      }
      
      .install-button:active {
        transform: translateY(0);
      }
      
      .install-note {
        text-align: center;
        font-size: 13px;
        color: #6b7280;
        margin-top: 12px;
      }
      
      @media (max-width: 768px) {
        .header h1 {
          font-size: 28px;
        }
        .header p {
          font-size: 16px;
        }
        .card {
          padding: 24px;
        }
        .version-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .version-selector {
          width: 100%;
        }
        .features {
          grid-template-columns: 1fr;
        }
      }
      
      /* Dark Theme */
      @media (prefers-color-scheme: dark) {
        body {
          background: #0f172a;
        }
        
        .header {
          background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        
        .card {
          background: #1e293b;
          border-color: #334155;
        }
        
        h2, h3 {
          color: #f1f5f9;
        }
        
        .version-selector {
          background: #0f172a;
          color: #f1f5f9;
          border-color: #475569;
        }
        
        .version-selector:hover {
          border-color: #60a5fa;
          box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }
        
        .version-selector:focus {
          border-color: #60a5fa;
          box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }
        
        .version-selector option {
          background: #0f172a;
          color: #f1f5f9;
        }
        
        .version-info {
          background: #0f172a;
        }
        
        .version-info span {
          color: #94a3b8;
        }
        
        .version-info strong {
          color: #cbd5e1;
        }
        
        .info-box {
          background: #0f172a;
          border-left-color: #60a5fa;
        }
        
        .info-box h3 {
          color: #93c5fd;
        }
        
        .info-box li {
          color: #bfdbfe;
        }
        
        .feature {
          background: #0f172a;
          border-color: #334155;
        }
        
        .feature:hover {
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          border-color: #475569;
        }
        
        .feature h3 {
          color: #f1f5f9;
        }
        
        .feature p {
          color: #94a3b8;
        }
        
        .install-button {
          background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
          box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }
        
        .install-button:hover {
          box-shadow: 0 6px 16px rgba(37, 99, 235, 0.5);
        }
        
        .install-note {
          color: #94a3b8;
        }
        
        .footer {
          background: #1e293b;
          border-top-color: #334155;
          color: #94a3b8;
        }
        
        .footer a {
          color: #60a5fa;
        }
        
        .footer a:hover {
          color: #93c5fd;
        }
        
        .release-notes {
          color: #cbd5e1;
        }
        
        .release-notes h3, .release-notes h4 {
          color: #f1f5f9;
        }
        
        .release-notes li {
          color: #94a3b8;
        }
        
        .release-notes p {
          color: #94a3b8;
        }
      }
    </style>
    
    <!-- Load ESP Web Tools component -->
    <script type="module">
      import "https://unpkg.com/esp-web-tools/dist/web/install-button.js?module";
    </script>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <h1>RX5808-Div Firmware Configurator</h1>
      <p>Firmware management for RX5808 Diversity FPV drone video receivers</p>
    </div>

    <div class="container">
      <!-- About Section -->
      <div class="card">
        <h2>About</h2>
        <p>The <strong>RX5808 Diversity</strong> is a dual-receiver analog video system designed for FPV (First Person View) drone pilots. It features automatic diversity switching between two RX5808 receiver modules to maintain the strongest video signal, ensuring reliable real-time video feed during flight.</p>
        <p>This <strong>web-based configurator</strong> provides a simple way to flash and manage firmware on your RX5808-Div device directly from your browser—no software installation required. Update to the latest features, configure wireless control via ExpressLRS, customize band mappings, and more.</p>
      </div>

      <!-- System Requirements -->
      <div class="card">
        <div class="info-box">
          <h3>System Requirements</h3>
          <p>Chrome, Edge, or Opera browser • USB connection to device</p>
        </div>
      </div>
      
      <!-- Key Features -->
      <div class="card">
        <h2>Key Features</h2>
        <div class="features">
          <div class="feature">
            <h3>ELRS Backpack Wireless Control</h3>
            <p>ExpressLRS wireless VRX integration via ESP-NOW protocol enables remote channel switching and settings control from your radio transmitter</p>
          </div>
          <div class="feature">
            <h3>Adaptive Diversity Modes</h3>
            <p>Optimized switching algorithms for Race (fast switching, 10ms), Freestyle (balanced, 30ms), and Long Range (stable, 100ms) flying styles</p>
          </div>
          <div class="feature">
            <h3>Quick Channel Scan</h3>
            <p>Rapidly scans all active channels and displays real-time RSSI strength for quick frequency identification and conflict detection</p>
          </div>
          <div class="feature">
            <h3>Diversity Calibration</h3>
            <p>Auto-calibration system adjusts RSSI thresholds and switching hysteresis for optimal diversity performance based on your receiver setup</p>
          </div>
          <div class="feature">
            <h3>Quick Access Menu</h3>
            <p>Streamlined on-screen interface provides instant access to band selection, scanner, calibration, and settings without navigating deep menus</p>
          </div>
          <div class="feature">
            <h3>Full Band Coverage</h3>
            <p>Support for all 6 standard FPV bands (A, B, E, F, R, L) with 8 channels each, plus configurable band remapping for VTX compatibility</p>
          </div>
        </div>
      </div>
      
      <!-- Firmware Installation -->
      <div class="card">
        <div class="version-header">
          <h2><span id="release-title">Loading...</span></h2>
          <select id="version-selector" class="version-selector">
            <option value="">Loading versions...</option>
          </select>
        </div>
        
        <div class="version-info">
          <span><strong>Release Date:</strong> <span id="release-date">-</span></span>
          <span><strong>Build:</strong> <span id="commit-hash">-</span></span>
        </div>
        
        <esp-web-install-button id="install-button">
          <button slot="activate" class="install-button">
            <span id="install-text">Loading...</span>
          </button>
        </esp-web-install-button>
        
        <p class="install-note">
          Connect your device via USB and click the button to begin firmware installation
        </p>
      </div>
      
      <!-- Release Notes -->
      <div class="card" id="whats-new-section">
        <h2>Release Notes: <span id="whats-new-version">v1.7.0</span></h2>
        <div id="release-notes" class="release-notes">
          <p style="text-align: center; color: #9ca3af;">Loading release information...</p>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="footer">
        <p>
          <a href="https://github.com/LochnessFPV/RX5808-Div" target="_blank">Documentation</a> • 
          <a href="https://github.com/LochnessFPV/RX5808-Div/releases" target="_blank">Release History</a> • 
          <a href="https://github.com/LochnessFPV/RX5808-Div/issues" target="_blank">Support</a>
        </p>
        <p style="margin-top: 12px;">
          Created by <a href="https://github.com/LochnessFPV" target="_blank">Lochness_FPV</a> • Powered by ESP Web Tools
        </p>
      </div>
    </div>

    <script>
      // Analytics configuration - Replace with your Cloudflare Worker URL
      const ANALYTICS_ENDPOINT = 'https://rx5808-analytics.lochnessfpv.workers.dev';

      // Generate or retrieve visitor ID
      function getVisitorId() {
        let visitorId = localStorage.getItem('visitor_id');
        if (!visitorId) {
          visitorId = 'v_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('visitor_id', visitorId);
        }
        return visitorId;
      }

      // Get referrer (cleaned)
      function getReferrer() {
        const ref = document.referrer;
        if (!ref) return 'Direct';
        try {
          const url = new URL(ref);
          if (url.hostname.includes('google')) return 'Google';
          if (url.hostname.includes('facebook')) return 'Facebook';
          if (url.hostname.includes('reddit')) return 'Reddit';
          if (url.hostname.includes('twitter') || url.hostname.includes('x.com')) return 'Twitter';
          if (url.hostname.includes('youtube')) return 'YouTube';
          if (url.hostname === window.location.hostname) return 'Internal';
          return url.hostname;
        } catch (e) {
          return 'Unknown';
        }
      }

      // Track time on page
      let pageLoadTime = Date.now();
      window.addEventListener('beforeunload', () => {
        const timeOnPage = Math.round((Date.now() - pageLoadTime) / 1000); // seconds
        if (timeOnPage > 3 && timeOnPage < 3600) { // between 3s and 1h
          trackEvent('time_on_page', { timeOnPage, visitor_id: getVisitorId() });
        }
      });

      // Analytics tracking
      async function trackEvent(eventType, eventData = {}) {
        if (ANALYTICS_ENDPOINT === 'YOUR_WORKER_URL_HERE') {
          return; // Analytics not configured yet
        }
        
        try {
          await fetch(`${ANALYTICS_ENDPOINT}/track`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              event: eventType,
              visitor_id: getVisitorId(),
              referrer: getReferrer(),
              ...eventData,
            }),
          });
        } catch (error) {
          // Silently fail - don't interrupt user experience
          console.debug('Analytics tracking failed:', error);
        }
      }

      // Firmware version management
      let currentVersion = null;
      let allVersions = [];

      // Load latest firmware info on page load
      async function loadLatestVersion() {
        try {
          const response = await fetch('firmware/latest.json');
          const data = await response.json();
          currentVersion = data;
          updateUI(data);
          loadAvailableVersions();
        } catch (error) {
          console.error('Failed to load latest version:', error);
          showError();
        }
      }

      // Load all available versions for selector
      async function loadAvailableVersions() {
        try {
          const response = await fetch('firmware/versions.json');
          const data = await response.json();
          allVersions = data.versions;
          populateVersionSelector();
        } catch (error) {
          console.error('Failed to load versions:', error);
        }
      }

      // Populate version dropdown
      function populateVersionSelector() {
        const selector = document.getElementById('version-selector');
        selector.innerHTML = '';
        
        allVersions.forEach((ver, index) => {
          const option = document.createElement('option');
          option.value = ver.version;
          option.text = `${ver.version}${index === 0 ? ' (Latest)' : ''}`;
          selector.appendChild(option);
        });
        
        selector.value = currentVersion.version;
        selector.addEventListener('change', handleVersionChange);
      }

      // Handle version selection change
      async function handleVersionChange(event) {
        const selectedVersion = event.target.value;
        const versionData = allVersions.find(v => v.version === selectedVersion);
        
        // Track version selection
        trackEvent('version_selected', { version: selectedVersion });
        
        if (versionData) {
          // Load manifest for selected version
          try {
            const manifestResponse = await fetch(versionData.manifest_url);
            const manifestData = await manifestResponse.json();
            
            currentVersion = {
              version: versionData.version,
              build_date: manifestData.build_date,
              commit: manifestData.commit,
              release_date: versionData.release_date,
              description: versionData.description,
              manifest_url: versionData.manifest_url,
              changelog_url: manifestData.changelog_url
            };
            
            updateUI(currentVersion);
          } catch (error) {
            console.error('Failed to load version:', error);
          }
        }
      }

      // Update UI with version data
      function updateUI(data) {
        // Update title
        document.getElementById('release-title').textContent = `Latest Release: ${data.version}`;
        
        // Update version info
        const releaseDate = new Date(data.release_date || data.build_date).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        document.getElementById('release-date').textContent = releaseDate;
        document.getElementById('commit-hash').textContent = data.commit;
        
        // Update install button
        document.getElementById('install-text').textContent = `Install Firmware ${data.version}`;
        document.getElementById('install-button').setAttribute('manifest', data.manifest_url);
        
        // Update "What's New" section
        document.getElementById('whats-new-version').textContent = data.version;
        loadReleaseNotes(data);
      }

      // Load release notes from GitHub API
      async function loadReleaseNotes(data) {
        const notesContainer = document.getElementById('release-notes');
        
        try {
          // Extract repo info from changelog URL
          const repoMatch = data.changelog_url?.match(/github\.com\/([^\/]+)\/([^\/]+)/);
          if (!repoMatch) {
            console.warn('Invalid changelog URL:', data.changelog_url);
            throw new Error('Invalid changelog URL');
          }
          
          const [, owner, repo] = repoMatch;
          const version = data.version;
          
          console.log(`Fetching release notes for ${owner}/${repo} ${version}...`);
          
          // Fetch release info from GitHub API
          const apiUrl = `https://api.github.com/repos/${owner}/${repo}/releases/tags/${version}`;
          const response = await fetch(apiUrl);
          
          if (!response.ok) {
            console.warn(`GitHub API returned ${response.status} for ${apiUrl}`);
            
            // Check if it's a rate limit issue
            if (response.status === 403) {
              const rateLimitRemaining = response.headers.get('X-RateLimit-Remaining');
              if (rateLimitRemaining === '0') {
                console.error('GitHub API rate limit exceeded');
                notesContainer.innerHTML = `<p>⚠️ GitHub API rate limit reached. Showing basic info:</p><p>${data.description || 'No description available.'}</p><p><a href="${data.changelog_url}" target="_blank">View full release notes on GitHub →</a></p>`;
                return;
              }
            }
            
            throw new Error(`Release not found (${response.status})`);
          }
          
          const release = await response.json();
          console.log('Release data:', release);
          
          const body = release.body || data.description || 'No release notes available.';
          
          // If body is same as description, try to fetch from the changelog URL
          if (body === data.description && body.length < 100) {
            console.warn('Release body is empty or too short, showing description with link');
            notesContainer.innerHTML = `<p>${data.description}</p><p><a href="${data.changelog_url}" target="_blank">View full release notes on GitHub →</a></p>`;
            return;
          }
          
          // Convert markdown to basic HTML
          const htmlNotes = convertMarkdownToHTML(body);
          notesContainer.innerHTML = htmlNotes;
        } catch (error) {
          console.error('Failed to load release notes:', error);
          notesContainer.innerHTML = `<p>${data.description || 'Release notes unavailable.'}</p><p><a href="${data.changelog_url}" target="_blank">View release notes on GitHub →</a></p>`;
        }
      }

      // Simple markdown to HTML converter
      function convertMarkdownToHTML(markdown) {
        return markdown
          .split('\n')
          .map(line => {
            // Headers
            if (line.startsWith('###')) {
              return `<h4>${line.replace(/^###\s*/, '')}</h4>`;
            }
            if (line.startsWith('##')) {
              return `<h3>${line.replace(/^##\s*/, '')}</h3>`;
            }
            // Bullet points
            if (line.match(/^[•\-\*]\s/)) {
              return `<li>${line.replace(/^[•\-\*]\s*/, '')}</li>`;
            }
            // Empty lines
            if (line.trim() === '') {
              return '';
            }
            // Regular paragraphs
            return `<p>${line}</p>`;
          })
          .join('')
          .replace(/(<li>.*<\/li>)/gs, '<ul style="margin: 10px 0; padding-left: 20px;">$1</ul>');
      }

      // Show error state
      function showError() {
        document.getElementById('release-title').textContent = 'Error Loading Firmware';
        document.getElementById('install-text').textContent = 'Unable to load firmware';
        document.getElementById('release-notes').innerHTML = '<p style="color: #e53e3e;">Failed to load firmware information. Please try refreshing the page.</p>';
      }

      // Initialize on page load
      window.addEventListener('DOMContentLoaded', () => {
        loadLatestVersion();
        
        // Track page view
        trackEvent('page_view');
        
        // Setup ESP Web Tools event listeners for install tracking
        const installButton = document.getElementById('install-button');
        
        installButton.addEventListener('state-changed', (ev) => {
          const state = ev.detail.state;
          
          if (state === 'STATE_INITIALIZING') {
            // User clicked install button
            trackEvent('install_click', { version: currentVersion?.version || 'unknown' });
          } else if (state === 'STATE_FINISHED') {
            // Installation completed successfully
            trackEvent('install_success', { version: currentVersion?.version || 'unknown' });
          }
        });
        
        installButton.addEventListener('error-changed', (ev) => {
          if (ev.detail.error) {
            // Installation failed
            trackEvent('install_failed', { 
              version: currentVersion?.version || 'unknown',
              error: ev.detail.error
            });
          }
        });
      });
    </script>
  </body>
</html>
