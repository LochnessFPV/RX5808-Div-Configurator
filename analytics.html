<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Analytics Dashboard - RX5808-Div</title>
  <meta name="viewport" content="width=device-width" />
  <meta name="robots" content="noindex, nofollow">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f172a;
      color: #f1f5f9;
      padding: 40px 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    h1 {
      font-size: 32px;
      color: #60a5fa;
    }
    
    .subtitle {
      color: #94a3b8;
      font-size: 14px;
    }
    
    .refresh-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .refresh-btn:hover {
      opacity: 0.9;
    }
    
    .section {
      margin-bottom: 32px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #f1f5f9;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #334155;
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    
    .kpi-card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    
    .kpi-card::before {
      content: '';
      position: absolute;
      top:0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, #60a5fa, #3b82f6);
    }
    
    .kpi-label {
      font-size: 13px;
      color: #94a3b8;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .kpi-value {
      font-size: 28px;
      font-weight: 600;
      color: #60a5fa;
    }
    
    .kpi-subtext {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
    }
    
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
    }
    
    .chart-card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 24px;
    }
    
    .chart-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #f1f5f9;
    }
    
    .bar-chart {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
   
    .bar-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .bar-label {
      min-width: 100px;
      font-size: 13px;
      color: #cbd5e1;
      font-weight: 500;
    }
    
    .bar-container {
      flex: 1;
      background: #0f172a;
      border-radius: 4px;
      height: 28px;
      position: relative;
      overflow: hidden;
    }
    
    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      border-radius: 4px;
      transition: width 1s ease-out;
    }
    
    .bar-value {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      font-weight: 600;
      color: #f1f5f9;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    
    .line-chart {
      height: 250px;
      position: relative;
      margin-top: 20px;
    }
    
    .line-chart svg {
      width: 100%;
      height: 100%;
    }
    
    .chart-line {
      fill: none;
      stroke: #60a5fa;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .chart-area {
      fill: url(#gradient);
      opacity: 0.3;
    }
    
    .chart-label {
      fill: #94a3b8;
      font-size: 11px;
      font-family: inherit;
    }
    
    .chart-dot {
      fill: #60a5fa;
      stroke: #1e293b;
      stroke-width: 2;
    }
    
   .heatmap {
      display: grid;
      grid-template-columns: repeat(24, 1fr);
      gap: 4px;
      margin-top: 20px;
    }
    
    .heatmap-cell {
      aspect-ratio: 1;
      background: #0f172a;
      border-radius: 3px;
      position: relative;
      cursor: pointer;
    }
    
    .heatmap-cell:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1e293b;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      z-index: 10;
      margin-bottom: 4px;
    }
    
    .weekday-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 20px;
    }
    
    .weekday-bar {
      text-align: center;
    }
    
    .weekday-label {
      font-size: 11px;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    
    .weekday-value {
      height: 120px;
      background: #0f172a;
      border-radius: 6px;
      position: relative;
      overflow: hidden;
    }
    
    .weekday-fill {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: linear-gradient(180deg, #3b82f6, #60a5fa);
      border-radius: 6px 6px 0 0;
    }
    
    .weekday-count {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 16px;
      font-weight: 600;
      color: #f1f5f9;
      z-index: 1;
    }
    
    .geo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 20px;
    }
    
    .country-card {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 6px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .country-name {
      font-size: 13px;
      color: #cbd5e1;
      font-weight: 500;
    }
    
    .country-count {
      font-size: 16px;
      font-weight: 600;
      color: #60a5fa;
    }
    
    .country-flag {
      font-size: 20px;
      margin-right: 8px;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #94a3b8;
    }
    
    .error {
      background: #7f1d1d;
      border: 1px solid #991b1b;
      border-radius: 8px;
      padding: 20px;
      color: #fecaca;
    }
    
    .last-updated {
      text-align: center;
      color: #64748b;
      font-size: 13px;
      margin-top: 40px;
    }
    
    @media (max-width: 768px) {
      .chart-grid {
        grid-template-columns: 1fr;
      }
      .heatmap {
        grid-template-columns: repeat(12, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>Analytics Dashboard</h1>
        <p class="subtitle">RX5808-Div Configurator ‚Äî Real-time Usage Statistics</p>
      </div>
      <button class="refresh-btn" onclick="loadAnalytics()">‚Üª Refresh Data</button>
    </div>
    
    <div id="content">
      <div class="loading">Loading analytics data...</div>
    </div>
    
    <div class="last-updated" id="last-updated"></div>
  </div>

  <script>
    const ANALYTICS_ENDPOINT = 'https://rx5808-analytics.lochnessfpv.workers.dev';

    async function loadAnalytics() {
      const content = document.getElementById('content');
      content.innerHTML = '<div class="loading">Loading analytics data...</div>';

      try {
        const response = await fetch(`${ANALYTICS_ENDPOINT}/stats`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        renderDashboard(data);
        
        document.getElementById('last-updated').textContent = 
          `Last updated: ${new Date().toLocaleString()}`;
      } catch (error) {
        console.error('Failed to load analytics:', error);
        content.innerHTML = `
          <div class="error">
            <strong>Failed to load analytics</strong><br>
            Make sure you've deployed the Cloudflare Worker and updated the ANALYTICS_ENDPOINT URL.<br>
            Error: ${error.message}
          </div>
        `;
      }
    }

    function renderDashboard(data) {
      // Calculate metrics
      const totalInstalls = Object.values(data.installClicks).reduce((a, b) => a + b, 0);
      const totalSuccess = Object.values(data.installSuccess).reduce((a, b) => a + b, 0);
      const totalFailed = Object.values(data.installFailed).reduce((a, b) => a + b, 0);
      const successRate = totalInstalls > 0 ? ((totalSuccess / totalInstalls) * 100).toFixed(1) : 0;
      const avgTime = data.avgTimeOnPage || 0;
      const returnRate = data.uniqueVisitors > 0 ? 
        ((1 - (data.uniqueVisitors / data.pageViews)) * 100).toFixed(1) : 0;
      
      // Calculate monthly growth
      const monthlyEntries = Object.entries(data.monthlyStats).sort((a, b) => a[0].localeCompare(b[0]));
      let growthRate = 0;
      if (monthlyEntries.length >= 2) {
        const current = monthlyEntries[monthlyEntries.length - 1][1];
        const previous = monthlyEntries[monthlyEntries.length - 2][1];
        growthRate = previous > 0 ? (((current - previous) / previous) * 100).toFixed(1) : 0;
      }

      const html = `
        <!-- Key Performance Indicators -->
        <div class="section">
          <h2 class="section-title">Key Performance Indicators</h2>
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-label">Total Visitors</div>
              <div class="kpi-value">${data.pageViews.toLocaleString()}</div>
              <div class="kpi-subtext">${data.uniqueVisitors} unique</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Installations</div>
              <div class="kpi-value">${totalInstalls.toLocaleString()}</div>
              <div class="kpi-subtext">${successRate}% success rate</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Conversion Rate</div>
              <div class="kpi-value">${data.conversionRate}%</div>
              <div class="kpi-subtext">visitors to installers</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Avg Time on Page</div>
              <div class="kpi-value">${formatTime(avgTime)}</div>
              <div class="kpi-subtext">per session</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Geographic Reach</div>
              <div class="kpi-value">${data.geographicReach}</div>
              <div class="kpi-subtext">countries</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Monthly Growth</div>
              <div class="kpi-value">${growthRate > 0 ? '+' : ''}${growthRate}%</div>
              <div class="kpi-subtext">month over month</div>
            </div>
          </div>
        </div>

        <!-- Growth & Trends -->
        <div class="section">
          <h2 class="section-title">Growth & Trends</h2>
          <div class="chart-grid">
            <div class="chart-card" style="grid-column: 1 / -1;">
              <div class="chart-title">Daily Traffic</div>
              <div class="line-chart">
                ${renderLineChart(data.dailyStats)}
              </div>
            </div>
          </div>
        </div>

        <!-- Usage Patterns -->
        <div class="section">
          <h2 class="section-title">Usage Patterns</h2>
          <div class="chart-grid">
            <div class="chart-card">
              <div class="chart-title">Hourly Distribution (24h UTC)</div>
              <div class="heatmap">
                ${renderHeatmap(data.hourlyStats)}
              </div>
            </div>
            <div class="chart-card">
              <div class="chart-title">Weekly Pattern</div>
              <div class="weekday-grid">
                ${renderWeekdayChart(data.weekdayStats)}
              </div>
            </div>
          </div>
        </div>

        <!-- User Demographics -->
        <div class="section">
          <h2 class="section-title">User Demographics</h2>
          <div class="chart-grid">
            <div class="chart-card">
              <div class="chart-title">Browsers</div>
              <div class="bar-chart">
                ${renderBarChart(data.browsers)}
              </div>
            </div>
            <div class="chart-card">
              <div class="chart-title">Devices</div>
              <div class="bar-chart">
                ${renderBarChart(data.devices)}
              </div>
            </div>
            <div class="chart-card">
              <div class="chart-title">Traffic Sources</div>
              <div class="bar-chart">
                ${renderBarChart(data.referrers)}
              </div>
            </div>
          </div>
        </div>

        <!-- Firmware Analytics -->
        <div class="section">
          <h2 class="section-title">Firmware Analytics</h2>
          <div class="chart-grid">
            <div class="chart-card">
              <div class="chart-title">Version Selections</div>
              <div class="bar-chart">
                ${renderBarChart(data.versionSelections)}
              </div>
            </div>
            <div class="chart-card">
              <div class="chart-title">Installation Attempts</div>
              <div class="bar-chart">
                ${renderBarChart(data.installClicks)}
              </div>
            </div>
            <div class="chart-card">
              <div class="chart-title">Successful Installations</div>
              <div class="bar-chart">
                ${renderBarChart(data.installSuccess)}
              </div>
            </div>
            <div class="chart-card">
              <div class="chart-title">Failed Installations</div>
              <div class="bar-chart">
                ${renderBarChart(data.installFailed)}
              </div>
            </div>
          </div>
        </div>

        <!-- Geographic Distribution -->
        <div class="section">
          <h2 class="section-title">Geographic Distribution</h2>
          <div class="chart-card">
            <div class="geo-grid">
              ${renderCountryCards(data.countries)}
            </div>
          </div>
        </div>
      `;

      document.getElementById('content').innerHTML = html;
    }

    function formatTime(seconds) {
      if (seconds < 60) return `${seconds}s`;
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${minutes}m ${secs}s`;
    }

    function renderLineChart(dailyData) {
      const entries = Object.entries(dailyData).sort((a, b) => a[0].localeCompare(b[0]));
      
      if (entries.length === 0) {
        return '<p style="color: #64748b; text-align: center; padding: 80px 0;">No daily data yet</p>';
      }

      const width = 800;
      const height = 200;
      const padding = 40;
      const maxValue = Math.max(...entries.map(e => e[1]));
      const step = (width - padding * 2) / Math.max(entries.length - 1, 1);

      const points = entries.map(([date, value], index) => {
        const x = padding + index * step;
        const y = height - padding - ((value / maxValue) * (height - padding * 2));
        return `${x},${y}`;
      });

      const linePath = `M ${points.join(' L ')}`;
      const areaPath = `${linePath} L ${width - padding},${height - padding} L ${padding},${height - padding} Z`;

      const maxLabels = Math.min(entries.length, 10);
      const labelStep = Math.ceil(entries.length / maxLabels);
      const labels = entries.map(([date, value], index) => {
        if (index % labelStep !== 0 && index !== entries.length - 1) return '';
        const x = padding + index * step;
        const formattedDate = new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        return `<text x="${x}" y="${height - 10}" class="chart-label" text-anchor="middle">${formattedDate}</text>`;
      }).join('');

      const dots = entries.map(([date, value], index) => {
        const x = padding + index * step;
        const y = height - padding - ((value / maxValue) * (height - padding * 2));
        return `<circle cx="${x}" cy="${y}" r="3" class="chart-dot"/>`;
      }).join('');

      return `
        <svg viewBox="0 0 ${width} ${height}" style="width: 100%; height: 100%;">
          <defs>
            <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:0.4" />
              <stop offset="100%" style="stop-color:#60a5fa;stop-opacity:0" />
            </linearGradient>
          </defs>
          <path d="${areaPath}" class="chart-area"/>
          <path d="${linePath}" class="chart-line"/>
          ${dots}
          ${labels}
        </svg>
      `;
    }

    function renderHeatmap(hourlyData) {
      const maxValue = Math.max(...Object.values(hourlyData), 1);
      
      return Array.from({length: 24}, (_, hour) => {
        const value = hourlyData[hour] || 0;
        const intensity = value / maxValue;
        const color = `rgba(96, 165, 250, ${intensity})`;
        return `<div class="heatmap-cell" style="background: ${color};" data-tooltip="${hour}:00 - ${value} events"></div>`;
      }).join('');
    }

    function renderWeekdayChart(weekdayData) {
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const maxValue = Math.max(...Object.values(weekdayData), 1);
      
      return days.map((day, index) => {
        const value = weekdayData[index] || 0;
        const percentage = (value / maxValue) * 100;
        return `
          <div class="weekday-bar">
            <div class="weekday-label">${day}</div>
            <div class="weekday-value">
              <div class="weekday-fill" style="height: ${percentage}%"></div>
              <div class="weekday-count">${value}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderBarChart(dataObj) {
      const entries = Object.entries(dataObj).sort((a, b) => b[1] - a[1]).slice(0, 8);
      
      if (entries.length === 0) {
        return '<p style="color: #64748b; text-align: center;">No data yet</p>';
      }

      const maxValue = Math.max(...entries.map(e => e[1]));

      return entries.map(([label, value]) => {
        const percentage = (value / maxValue) * 100;
        return `
          <div class="bar-row">
            <div class="bar-label">${label}</div>
            <div class="bar-container">
              <div class="bar-fill" style="width: ${percentage}%"></div>
              <div class="bar-value">${value}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderCountryCards(countries) {
      const entries = Object.entries(countries).sort((a, b) => b[1] - a[1]);
      
      if (entries.length === 0) {
        return '<p style="color: #64748b; text-align: center; grid-column: 1/-1;">No geographic data yet</p>';
      }

      const countryData = {
        'US': { name: 'United States', flag: 'üá∫üá∏' },
        'GB': { name: 'United Kingdom', flag: 'üá¨üáß' },
        'CA': { name: 'Canada', flag: 'üá®üá¶' },
        'AU': { name: 'Australia', flag: 'üá¶üá∫' },
        'DE': { name: 'Germany', flag: 'üá©üá™' },
        'FR': { name: 'France', flag: 'üá´üá∑' },
        'ES': { name: 'Spain', flag: 'üá™üá∏' },
        'IT': { name: 'Italy', flag: 'üáÆüáπ' },
        'NL': { name: 'Netherlands', flag: 'üá≥üá±' },
        'SE': { name: 'Sweden', flag: 'üá∏üá™' },
        'NO': { name: 'Norway', flag: 'üá≥üá¥' },
        'DK': { name: 'Denmark', flag: 'üá©üá∞' },
        'FI': { name: 'Finland', flag: 'üá´üáÆ' },
        'PL': { name: 'Poland', flag: 'üáµüá±' },
        'BR': { name: 'Brazil', flag: 'üáßüá∑' },
        'MX': { name: 'Mexico', flag: 'üá≤üáΩ' },
        'AR': { name: 'Argentina', flag: 'üá¶üá∑' },
        'CL': { name: 'Chile', flag: 'üá®üá±' },
        'JP': { name: 'Japan', flag: 'üáØüáµ' },
        'KR': { name: 'South Korea', flag: 'üá∞üá∑' },
        'CN': { name: 'China', flag: 'üá®üá≥' },
        'IN': { name: 'India', flag: 'üáÆüá≥' },
        'SG': { name: 'Singapore', flag: 'üá∏üá¨' },
        'NZ': { name: 'New Zealand', flag: 'üá≥üáø' },
        'ZA': { name: 'South Africa', flag: 'üáøüá¶' },
        'RU': { name: 'Russia', flag: 'üá∑üá∫' },
        'UA': { name: 'Ukraine', flag: 'üá∫üá¶' },
        'TR': { name: 'Turkey', flag: 'üáπüá∑' },
        'IL': { name: 'Israel', flag: 'üáÆüá±' },
        'AE': { name: 'UAE', flag: 'üá¶üá™' },
        'BE': { name: 'Belgium', flag: 'üáßüá™' },
        'AT': { name: 'Austria', flag: 'üá¶üáπ' },
        'CH': { name: 'Switzerland', flag: 'üá®üá≠' },
        'PT': { name: 'Portugal', flag: 'üáµüáπ' },
        'GR': { name: 'Greece', flag: 'üá¨üá∑' },
        'CZ': { name: 'Czech Republic', flag: 'üá®üáø' },
        'IE': { name: 'Ireland', flag: 'üáÆüá™' },
        'HU': { name: 'Hungary', flag: 'üá≠üá∫' },
        'RO': { name: 'Romania', flag: 'üá∑üá¥' },
        'TH': { name: 'Thailand', flag: 'üáπüá≠' },
        'PH': { name: 'Philippines', flag: 'üáµüá≠' },
        'MY': { name: 'Malaysia', flag: 'üá≤üáæ' },
        'ID': { name: 'Indonesia', flag: 'üáÆüá©' },
        'VN': { name: 'Vietnam', flag: 'üáªüá≥' },
        'HK': { name: 'Hong Kong', flag: 'üá≠üá∞' },
        'TW': { name: 'Taiwan', flag: 'üáπüáº' },
        'Unknown': { name: 'Unknown', flag: 'üåç' }
      };

      return entries.map(([countryCode, count]) => {
        const country = countryData[countryCode] || { name: countryCode, flag: 'üåç' };
        return `
          <div class="country-card">
            <div style="display: flex; align-items: center;">
              <span class="country-flag">${country.flag}</span>
              <span class="country-name">${country.name}</span>
            </div>
            <span class="country-count">${count}</span>
          </div>
        `;
      }).join('');
    }

    window.addEventListener('DOMContentLoaded', loadAnalytics);
  </script>
</body>
</html>
